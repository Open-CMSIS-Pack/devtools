
name: nightly

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  buildmgr:
    if: github.repository == 'Open-CMSIS-Pack/devtools'
    uses: Open-CMSIS-Pack/devtools/.github/workflows/buildmgr.yml@main
    secrets: inherit
  packchk:
    needs: [buildmgr]
    uses: Open-CMSIS-Pack/devtools/.github/workflows/packchk.yml@main
    secrets: inherit
  packgen:
    needs: [packchk]
    uses: Open-CMSIS-Pack/devtools/.github/workflows/packgen.yml@main
    secrets: inherit
  projmgr:
    needs: [packgen]
    uses: Open-CMSIS-Pack/devtools/.github/workflows/projmgr.yml@main
    secrets: inherit
  svdconv:
    needs: [projmgr]
    uses: Open-CMSIS-Pack/devtools/.github/workflows/svdconv.yml@main
    secrets: inherit
  test_libs:
    needs: [svdconv]
    uses: Open-CMSIS-Pack/devtools/.github/workflows/test_libs.yml@main
  coverage:
    runs-on: ubuntu-22.04
    needs: [ buildmgr, packchk, packgen, projmgr, svdconv, test_libs ]
    steps:
      - name: Harden Runner
        if: ${{ !github.event.repository.private }}
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install \
            lcov

      - name: Download coverage report
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          pattern: coverage-report-*
          path: coverage/
          merge-multiple: true

      - name: Consolidate coverage data
        run: |
          lcov --rc lcov_branch_coverage=1 --add-tracefile coverage_packchk.info -a coverage_packgen.info -a coverage_projmgr.info -a coverage_buildmgr.info -a coverage_svdconv.info -o merged_coverage.info
        working-directory: coverage/

      - name: Archive merged coverage report
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: merged-coverage-report
          path: ./coverage/merged_coverage.info
          if-no-files-found: error
