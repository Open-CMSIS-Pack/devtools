# YAML CBuild Format
<!-- markdownlint-disable MD013 -->
<!-- markdownlint-disable MD036 -->

The following chapter explains the YAML CBuild format that describes how to build a complete application.

**Table of Contents**

- [YAML CBuild Format](#yaml-cbuild-format)
  - [CBuild Output Files](#cbuild-output-files)
    - [Directory Structure](#directory-structure)
    - [File Structure of `*.cbuild-idx.yml`](#file-structure-of-cbuild-idxyml)
    - [File Structure of `*.cbuild.yml`](#file-structure-of-cbuildyml)
  - [CBuild-specific Nodes](#cbuild-specific-nodes)
    - [`licenses:`](#licenses)
    - [`cprojects:`](#cprojects)
    - [`context-set:`](#context-set)
    - [`packs:`](#packs)
    - [`generators:`](#generators)
  - [Source File Management](#source-file-management)
    - [`linker:`](#linker)
    - [`groups:`](#groups)
    - [`files:` of a group](#files-of-a-group)
    - [`components:`](#components)
    - [`files:` of a component](#files-of-a-component)
  - [`constructed-files:`](#constructed-files)
    - [`messages:`](#messages)

## CBuild Output Files

The `*.cbuild-idx.yml` and `*.cbuild.yml` output files are generated by the `csolution` utility and contain information on how to build the complete application.

File                | Description
:-------------------|:----------------------
`*.cbuild-idx.yml`  | Index file of all `*.cbuild.yml` build descriptions; contains also overall information for the application.
`*.cbuild.yml`      | Build description of a single [`*.cproject.yml`](YML-Input-Format.md#project-file-structure) input file.

The `*.cbuild.yml` output file has the following usage:

- It contains all information for the build step of a project that is part of an application.
- As it contains information about all software packs used including version information, this file can be used as `lock-file` to ensure that subsequent runs of `csolution` use the very same software packs.
- It can be used as input file for a generator as it contains explicit information about source files and avoids the complexity of a pack data management at the generator level.

### Directory Structure

As `csolution` based projects should be portable across different host computers, **relative file references** are used within the directory structure.

- All file references use relative paths to the base directory of the related `*.yml` file.  Files that are within the file structure of the `csolution` base directory are also referenced using relative paths, i.e. `../layers/layer1/source-file1.c`.

> ToDo: Question: when are relative paths used to the base directory and when are absolute paths used?

- Files that are located in the [CMSIS-Pack root directory](https://github.com/Open-CMSIS-Pack/cmsis-toolbox/blob/main/docs/installation.md#environment-variables) are prefixed with %CMSIS_PACK_ROOT%.

- Files outside of the directory structure of `csolution` based application use absolute paths. If absolute paths are used, a `warning` is issued in the `*.cbuild-idx.yml` file.

A typical directory structure of a `csolution` based application that uses common layers source files is shown below.

```yml
ðŸ“¦ # csolution base directory
 â”£ myapp.csolution.yml
 â”£ myapp.cbuild-idx.yml
 â”£ ðŸ“‚ project1
 â”ƒ  â”£  mypro1.cproject.yml
 â”ƒ  â”£  mypro1.cbuild.yml       # file references are relative to directory project1
 â”£ ðŸ“‚ project2
 â”ƒ  â”£  mypro2.cproject.yml
 â”ƒ  â”£  mypro2.cbuild.yml       # file references are relative to directory project2
 â”£ ðŸ“‚ layer
```

### File Structure of `*.cbuild-idx.yml`

`build-idx:`                                       | Content
:--------------------------------------------------|:------------------------------------
&nbsp;&nbsp; `generated-by:`                       | Reference to csolution tool along with version information used to generate this application.
&nbsp;&nbsp; `cdefault:`                           | Relative path and name of the [`*.cdefault.yml`](YML-Input-Format.md#default) input file used to generate this application.
&nbsp;&nbsp; `csolution:`                          | Relative path and name of the [`*.csolution.yml`](YML-Input-Format.md#solution) input file used to generate this application.
&nbsp;&nbsp; [`cprojects:`](#cprojects)            | List of `*.cproject.yml` and `*.clayer.yml` input files used to generate this application.
&nbsp;&nbsp; [`licenses:`](#licenses)              | ToDo: List of software license agreements used by this application.
&nbsp;&nbsp; `cbuilds:`                            | List of `*.cbuild.yml` output files that are generated for this application.
&nbsp;&nbsp; [`context-set:`](#context-set)        | Selected context that is generated for this application.

**Example:**

```yml  
build-idx:
  generated-by: csolution 1.4.0
  cdefault: HelloWorld.cdefault.yml
  csolution: HelloWorld.csolution.yml
  cprojects:
    - cproject: cm0plus/HelloWorld_cm0plus.cproject.yml
    - cproject: cm4/HelloWorld_cm4.cproject.yml

  licenses:        # ToDo: all licenses used in the projects  

  cbuilds:
    - cbuild: cm0plus/HelloWorld_cm0plus.Debug+FRDM-K32L3A6.cbuild.yml
    - cbuild: cm0plus/HelloWorld_cm0plus.Release+FRDM-K32L3A6.cbuild.yml
    - cbuild: cm4/HelloWorld_cm4.Debug+FRDM-K32L3A6.cbuild.yml
    - cbuild: cm4/HelloWorld_cm4.Release+FRDM-K32L3A6.cbuild.yml
```

### File Structure of `*.cbuild.yml`

The `cbuild.yml` file is structured into several sections.  The top-level structure is outlined below.

`build:`                                           | Content
:--------------------------------------------------|:------------------------------------
&nbsp;&nbsp; `generated-by:`                       | Reference to csolution tool along with version information used to generate this application.
&nbsp;&nbsp; `context:`                            | Project [context](YML-Input-Format.md#context-name-conventions) of this build description.
&nbsp;&nbsp; `compiler:`                           | [Compiler toolchain](YML-Input-Format.md#compiler) used for code generation.
&nbsp;&nbsp; `board:`                              | [Board name](YML-Input-Format.md#board) used for this context.
&nbsp;&nbsp; `device:`                             | [Device name](YML-Input-Format.md#device) with processor core selection used in this  project context.
&nbsp;&nbsp; `processor:`                          | List of [processor attributes](YML-Input-Format.md#processor) used in this project context.
&nbsp;&nbsp; [`packs:`](#packs)                    | List of software [packs](#packs) along with path information used to generate this project context.
&nbsp;&nbsp; `optimize:`                           | Generic [optimize](YML-Input-Format.md#optimize) level for code generation.
&nbsp;&nbsp; `debug:`                              | Global control the generation of [debug](YML-Input-Format.md#debug) information.
&nbsp;&nbsp; `warnings:`                           | Global control [warning](YML-Input-Format.md#warnings) level for compiler diagnostics.
&nbsp;&nbsp; `misc:`                               | Global control of [miscellaneous](YML-Input-Format.md#misc) literal tool-specific controls.
&nbsp;&nbsp; `define:`                             | List of global [define](YML-Input-Format.md#define) symbol settings.
&nbsp;&nbsp; `add-path:`                           | List of global [include path](YML-Input-Format.md#add-path) settings.
&nbsp;&nbsp; `output-type:`                        | Select the [output type](YML-Input-Format.md#output-type) (exe or lib) for this project context.
&nbsp;&nbsp; `output-dirs:`                        | Specifies the [directories](YML-Input-Format.md#output-dirs) used to generate the output files.
&nbsp;&nbsp; `linker:`                             | Specifies the [linker script processing](#linker) used to generate the output files.
&nbsp;&nbsp; [`components:`](#components)          | List of software components used.
&nbsp;&nbsp; [`groups:`](#groups)                  | List of source file groups along with source files.
&nbsp;&nbsp; [`constructed-files:`](#constructed-files) | List of files that are generated by RTE management of `csolution` tool.
&nbsp;&nbsp; [`messages:`](#messages)              | ToDo: List of messages (errors, warnings, etc.) that apply to this project context.

**Example:**

```yml
build:
  context: HelloWorld_cm0plus.Debug+FRDM-K32L3A6
  compiler: AC6
  device: K32L3A60VPJ1A:cm0plus
  processor:
    fpu: off
    endian: little
    trustzone: non-secure
  packs:
    - pack: ARM::CMSIS@5.9.0
      path: ${CMSIS_PACK_ROOT}/ARM/CMSIS/5.9.0
    - pack: NXP::K32L3A60_DFP@15.0.0
      path: ${CMSIS_PACK_ROOT}/NXP/K32L3A60_DFP/15.0.0
  optimize: none
  debug: on
  misc:
    C:
      - -std=c99
      - -fno-builtin
    CPP:
      - -fno-builtin
    Link:
      - --diag_suppress 6314
      - --entry=Reset_Handler
  define:
    - CPU_K32L3A60VPJ1A_cm0plus
    - MCMGR_HANDLE_EXCEPTIONS=1
           :
    - _RTE_
  add-path:
    - ../middleware/multicore/mcmgr/src
    - RTE/Board_Support/K32L3A60VPJ1A_cm0plus
    - RTE/_HelloWorld_cm0plus.Debug_FRDM-K32L3A6
    - ${CMSIS_PACK_ROOT}/ARM/CMSIS/5.9.0/CMSIS/Core/Include
    - ${CMSIS_PACK_ROOT}/NXP/K32L3A60_DFP/15.0.0
            :
  output-type: exe
  output-dirs:
    gendir: generated
    intdir: ../tmp/HelloWorld_cm0plus/FRDM-K32L3A6/Debug
    outdir: ../out/HelloWorld_cm0plus/FRDM-K32L3A6/Debug
    rtedir: RTE
  components:
    - component: ARM::CMSIS:CORE@5.6.0
      condition: ARMv6_7_8-M Device
      from-pack: ARM::CMSIS@5.9.0
      selected-by: ARM::CMSIS:CORE
    - component: NXP::Device:CMSIS:K32L3A60_system@1.0.0
      condition: device.K32L3A60_AND_device.K32L3A60_CMSIS
      from-pack: NXP::K32L3A60_DFP@15.0.0
      selected-by: NXP::Device:CMSIS:K32L3A60_system
      files:
        - file: ${CMSIS_PACK_ROOT}/NXP/K32L3A60_DFP/15.0.0/system_K32L3A60_cm0plus.c
          category: sourceC
    - component: NXP::Device:SDK Drivers:clock@2.2.1
      condition: device.K32L3A60_AND_driver.common
      from-pack: NXP::K32L3A60_DFP@15.0.0
      selected-by: NXP::Device:SDK Drivers:clock
      files:
        - file: ${CMSIS_PACK_ROOT}/NXP/K32L3A60_DFP/15.0.0/drivers/fsl_clock.c
          category: sourceC
    - component: NXP::Device:SDK Drivers:common@2.3.2
      condition: device.K32L3A60_AND_device.K32L3A60_CMSIS_AND_driver.clock
      from-pack: NXP::K32L3A60_DFP@15.0.0
      selected-by: NXP::Device:SDK Drivers:common
      files:
        - file: ${CMSIS_PACK_ROOT}/NXP/K32L3A60_DFP/15.0.0/drivers/fsl_common.c
          category: sourceC
        - file: ${CMSIS_PACK_ROOT}/NXP/K32L3A60_DFP/15.0.0/drivers/fsl_common_arm.c
          category: sourceC
            :
  groups:
    - group: Application
      files:
        - file: ./hello_world_core1.c
          category: sourceC
        - file: ./RTE/Device/K32L3A60VPJ1A_cm0plus/K32L3A60xxx_cm0plus_flash.scf
          category: linkerScript
    - group: Middleware
      files:
        - file: ../middleware/multicore/mcmgr/src/mcmgr.c
          category: sourceC
            :
  constructed-files:
    - file: RTE/_HelloWorld_cm0plus.Debug_FRDM-K32L3A6/RTE_Components.h
      category: header
```

## CBuild-specific Nodes

### `licenses:`

> ToDo

The `licenses:` node collects the software licenses from all components and software packs that are used in a `csolution` based software project.

`licenses:`                                                        | Content
:------------------------------------------------------------------|:------------------------------------
`- license:`                                                       | SPDX-name of the license, `<proprietary>` to indicate a dedicated license agreement, or `<unknown>`.
&nbsp;&nbsp;`license-agreement:`                                   | In cased of `<proprietary>` a link to the license agreement.
&nbsp;&nbsp; [`packs:`]                                            | List of software packs that use this license.
&nbsp;&nbsp; [`components:`]                                       | List of software components that use this license.

**Example:**

```yml
licenses:
  - license: Apache-2.0
    packs:
    - pack: ARM::CMSIS@5.9.0
    - pack: ARM::mbedTLS@1.7.0
    components:
    - component: ARM::CMSIS:RTOS2:FreeRTOS&Cortex-M

  - license: <unknown>
    packs:
    - pack: ARM::CMSIS-Driver@2.7.2

  - license: <proprietary>
    license-agreement: %CMSIS_PACK_ROOT%/Keil/STM32U5xx_DFP/2.0.0/Package_license.md
    packs:
    - pack: Keil::STM32U5xx_DFP@2.0.0
```

### `cprojects:`

The `cprojects:` node lists all `*.cproject.yml` input files along with `*.clayer.yml` files that are used to compose the application.

`cprojects:`                                                       | Content
:------------------------------------------------------------------|:------------------------------------
`- cproject:`                                                      | Relative path and name of a [`*.cproject.yml`](YML-Input-Format.md#project) input file.
&nbsp;&nbsp;`clayers:`                                             | List of [`*.clayer.yml`](YML-Input-Format.md#layer) input files used by this `*.cproject.yml` file.

**Example:**

```yml
  cprojects:
    - cproject: AWS_MQTT_MutualAuth_SW_Framework/Demo.cproject.yml
      clayers:
        - clayer: AWS_MQTT_MutualAuth_SW_Framework/Socket/FreeRTOS+TCP/Socket.clayer.yml
        - clayer: AWS_MQTT_MutualAuth_SW_Framework/Socket/WiFi/Socket.clayer.yml
        - clayer: AWS_MQTT_MutualAuth_SW_Framework/Socket/VSocket/Socket.clayer.yml
             :
```

### `context-set:`

**ToDo: Proposal (would replace cbuild: node)**

The `context-set:` node contains a list of generated files.  Note that this depends on the `--context` parameters that are passed to `csolution`.

The example below shows the content of the `DualCore` example with the following `csolution` invocation:

```txt
csolution convert HelloWorld.csolution.yml --context HelloWorld_cm0plus.Debug+FRDM-K32L3A6 --context -HelloWorld_cm4.Release+FRDM-K32L3A6 
```

```yml
  context-set:
    - context: HelloWorld_cm4.Release+FRDM-K32L3A6 
      bin: ./out/FRDM-K32L3A6/HelloWorld_cm4.bin
      hex: ./out/FRDM-K32L3A6/HelloWorld_cm4.hex
      elf: ./out/FRDM-K32L3A6/HelloWorld_cm4.axf
      map: ./out/FRDM-K32L3A6/HelloWorld_cm4.map
      log: ./out/FRDM-K32L3A6/HelloWorld_cm4.Release+FRDM-K32L3A6.log
    - context: HelloWorld_cm0plus.Debug+FRDM-K32L3A6 
      bin: ./out/FRDM-K32L3A6/HelloWorld_cm0plus.bin
      hex: ./out/FRDM-K32L3A6/HelloWorld_cm0plus.hex
      elf: ./out/FRDM-K32L3A6/HelloWorld_cm0plus.axf
      map: ./out/FRDM-K32L3A6/HelloWorld_cm0plus.map
      log: ./out/FRDM-K32L3A6/HelloWorld_cm0plus.Debug+FRDM-K32L3A6.log
```

### `packs:`

The `packs:` node is the start of a pack list that is used for the project context.

`packs:`                                              | Content
:-----------------------------------------------------|:------------------------------------
`- pack:`                                             | Explicit pack specification with exact version information used.
&nbsp;&nbsp; `path:`                                  | Path name that stores the software pack (see note).

> **Note:**
>
>Packs that are located in the [CMSIS-Pack root directory](https://github.com/Open-CMSIS-Pack/cmsis-toolbox/blob/main/docs/installation.md#environment-variables) are prefixed with %CMSIS_PACK_ROOT%.

**Example:**

```yml
  packs:
    - pack: ARM::CMSIS-FreeRTOS@10.4.6
      path: ${CMSIS_PACK_ROOT}/ARM/CMSIS-FreeRTOS/10.4.6
    - pack: ARM::CMSIS@5.9.0
      path: ${CMSIS_PACK_ROOT}/ARM/CMSIS/5.9.0
       :
    - pack: MDK-Packs::IoT_Socket@1.3.1
      path: ../IoT_Socket
```

### `generators:`

The `generators:` node contains information for calling a generator.

`generators:`                                                       | Content
:-------------------------------------------------------------------|:------------------------------------
`- generator:`                                                      | Section for a specific generator.
&nbsp;&nbsp; [`path:`](YML-Input-Format.md#generators)              | Path name for storing the files generated.
&nbsp;&nbsp; `gdpsc:`                                               | File name of the *.GDPSC file that stores the information in `path:`.
&nbsp;&nbsp; `command:`                                             | Section for invoking the generator on different Host operating systems.

**Example:**

```yml
  generators:
    - generator: STM32CubeMX
      path: RTE/Device
      gpdsc: RTE/Device/STM32L475VGTx/FrameworkCubeMX.gpdsc
      command:
        win:
          file: ${CMSIS_PACK_ROOT}/Keil/STM32L4xx_DFP/2.6.1/MDK/CubeMX/STM32CubeMxLauncher.exe
          arguments:
            - STM32L475VGTx
            - ../../Release+STM32L4.cprj
            - ${CMSIS_PACK_ROOT}/Keil/STM32L4xx_DFP/2.6.1
```

## Source File Management

Keyword          | Description
:----------------|:------------------------------------
`groups:`        | Start of a list that adds source groups and files.
`components:`    | Start of a list that adds software components.

### `linker:`

`linker:`                                         | Content
:-------------------------------------------------|:--------------------------------
`- regions:`                                      | Path and file name of `regions_<device_or_board>.h`, used to generate a Linker Script via pre-processor.
`- script:`                                       | Path and file name of the Linker Script template that is pre-processed.
[`- define:`](YML-Input-Format.md#define)         | Define symbol settings for the linker script file preprocessor.

### `groups:`

`groups:`                                                | Content
:--------------------------------------------------------|:------------------------------------
`- group:`                                               | Name of the group.
&nbsp;&nbsp; [`optimize:`](YML-Input-Format.md#optimize) | Optimize level for code generation.
&nbsp;&nbsp; [`debug:`](YML-Input-Format.md#debug)       | Generation of debug information.
&nbsp;&nbsp; [`warnings:`](YML-Input-Format.md#warnings) | Control generation of compiler diagnostics.
&nbsp;&nbsp; [`define:`](YML-Input-Format.md#define)     | Define symbol settings for code generation.
&nbsp;&nbsp; [`add-path:`](YML-Input-Format.md#add-path) | Additional include file paths.
&nbsp;&nbsp; [`misc:`](YML-Input-Format.md#misc)         | Literal tool-specific controls.
&nbsp;&nbsp; [`groups:`](#groups)                        | Start a nested list of groups.
&nbsp;&nbsp; [`files:`](#files-of-a-group)               | List of files that belong to a group

### `files:` of a group

`files:`                                                 | Content
:--------------------------------------------------------|:------------------------------------
`- file:`                                                | Name of the file.
&nbsp;&nbsp; [`category:`](https://open-cmsis-pack.github.io/Open-CMSIS-Pack-Spec/main/html/pdsc_components_pg.html#FileCategoryEnum) | File category according Open-CMSIS-Pack specification
&nbsp;&nbsp; [`optimize:`](YML-Input-Format.md#optimize) | Optimize level for code generation.
&nbsp;&nbsp; [`debug:`](YML-Input-Format.md#debug)       | Generation of debug information.
&nbsp;&nbsp; [`warnings:`](YML-Input-Format.md#warnings) | Control generation of compiler diagnostics.
&nbsp;&nbsp; [`define:`](YML-Input-Format.md#define)     | Define symbol settings for code generation.
&nbsp;&nbsp; [`add-path:`](YML-Input-Format.md#add-path) | Additional include file paths.
&nbsp;&nbsp; [`misc:`](YML-Input-Format.md#misc)         | Literal tool-specific controls.

### `components:`

`components:`                                            | Content
:--------------------------------------------------------|:------------------------------------
`- component:`                                           | Name of the software component.
&nbsp;&nbsp; [`condition:`](https://open-cmsis-pack.github.io/Open-CMSIS-Pack-Spec/main/html/pdsc_conditions_pg.html#element_condition) | Reference to the condition ID of the software pack that triggered inclusion of this component.
&nbsp;&nbsp; `from-pack:`                                | Pack that defines this component.
&nbsp;&nbsp; `selected-by:`                              | The original component name used in `cproject/clayer.YML`.
&nbsp;&nbsp; [`optimize:`](YML-Input-Format.md#optimize) | Optimize level for code generation.
&nbsp;&nbsp; [`debug:`](YML-Input-Format.md#debug)       | Generation of debug information.
&nbsp;&nbsp; [`warnings:`](YML-Input-Format.md#warnings) | Control generation of compiler diagnostics.
&nbsp;&nbsp; [`define:`](YML-Input-Format.md#define)     | Define symbol settings for code generation.
&nbsp;&nbsp; [`add-path:`](YML-Input-Format.md#add-path) | Additional include file paths.
&nbsp;&nbsp; [`misc:`](YML-Input-Format.md#misc)         | Literal tool-specific controls.
&nbsp;&nbsp; `instances:`                                | Configure component instances.
&nbsp;&nbsp; [`generator:`]                              | Generator ID for components that are configurable via a generator.
&nbsp;&nbsp; [`files:`](#files-of-a-component)           | List of files that belong to this component.

### `files:` of a component

`files:`                                                 | Content
:--------------------------------------------------------|:------------------------------------
`- file:`                                                | Name and path to the file.
&nbsp;&nbsp; [`category:`](https://open-cmsis-pack.github.io/Open-CMSIS-Pack-Spec/main/html/pdsc_components_pg.html#FileCategoryEnum) | File category according Open-CMSIS-Pack specification
&nbsp;&nbsp; [`attr:`](https://open-cmsis-pack.github.io/Open-CMSIS-Pack-Spec/main/html/pdsc_components_pg.html#FileAttributeEnum) | File category according Open-CMSIS-Pack specification
&nbsp;&nbsp; [`condition:`](https://open-cmsis-pack.github.io/Open-CMSIS-Pack-Spec/main/html/pdsc_conditions_pg.html#element_condition)                                  | Reference to the condition ID of the software pack that triggered inclusion of this file.

## `constructed-files:`

A list of files that are generated by the RTE management of the `csolution` tool.

`constructed-files:`                                     | Content
:--------------------------------------------------------|:------------------------------------
`- file:`                                                | Name and path to the file.
&nbsp;&nbsp; [`category:`](https://open-cmsis-pack.github.io/Open-CMSIS-Pack-Spec/main/html/pdsc_components_pg.html#FileCategoryEnum) | File category according Open-CMSIS-Pack specification

### `messages:`

> ToDo: Messages that apply to this project context.

`messages:`                                              | Content
:--------------------------------------------------------|:------------------------------------
`- error:`                                               | Error message
`- warning:`                                             | Warning message
`- info:`                                                | Info message
